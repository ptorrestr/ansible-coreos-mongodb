[Unit]
Description=mongod service
After=docker.service
Requires=docker.service
After=etcd.service
Requires=etcd.service
After=mongodata@%i.service
Requires=mongodata@%i.service

[Service]
KillMode=none
TimeoutStartSec=360
TimeoutStopSec=360
EnvironmentFile=/etc/environment
ExecStartPre=/usr/bin/etcdctl set /mongodb/cfgs/cfg%i ${COREOS_PUBLIC_IPV4}:27019
ExecStartPre=/usr/bin/docker pull {{ mongoc_image_name }}
ExecStartPre=-/usr/bin/docker rm -f mongocfg%i
ExecStart=/usr/bin/docker run -p 27019:27019 --name mongoc%i {{ mongoc_image_name }}
ExecStop=/usr/bin/docker stop -t 60 mongoc%i
ExecStopPost=-/usr/bin/docker rm -f mongoc%i
ExecStopPost=/usr/bin/etcdctl rm /mongodb/cfgs/cfg%i
Restart=on-failure

[X-Fleet]
Conflicts=%p@*.service
MachineOf=mongodata@%i.service
